# 1. Generate fasta files to generate alignments with new taxa
We use the perl script `phylip_to_fasta_and_extraseq.pl` to convert 
the alignment files for the "Laurasiatheria the rest" subtree in phylip format to fasta format.
In addition, it appends the sequences from the taxa within the main "Chiroptera" subtree
(i.e., *Pteropus vampyrus*, *Myotis lucifugus*) specified in the file 
`taxa_to_add_bats.txt` and also the taxa from the "Laurasiatheria cetartiodactyla" subtree 
by parsing the file `taxa_to_add_cet.txt` (i.e., *Vicugna pacos*, and *Capra hircus*).

**NOTE**: If you have not carried out the first filtering step for both "Laurasiatheria cetartiodactyla" 
and "Chiroptera" data subsets, you will not be able to proceed with the next steps. The files you need 
are those generated by the R script
[`Partition_seqs_for_MCMCtree_after_filtering.R`](https://github.com/sabifo4/mammals_dating/blob/main/02_SeqBayes_S2/00_Data_filtering/01_alignments/Partition_seqs_for_MCMCtree_after_filtering.R).
at the end of the first filtering step of each data subset. 

The following code can be run to generate the corresponding alignments for each 
of the partitions:

```sh
# Run from `00_perl_parsing`
# Generate directories 
for i in `seq 2 6`
do
mkdir $i 
done 

# mt12cp
cd 2
perl ../phylip_to_fasta_and_extraseq.pl  ../../../../../../01_alignments/00_mammal_alns/laurasiatheria_therest/laurasiatheria_therest_mt12cp.aln \
../../../../../../01_alignments/00_mammal_alns/chiroptera/chiroptera_mt12cp.aln ../taxa_to_add_bats.txt \
../../../../../../01_alignments/00_mammal_alns/laurasiatheria_cetartiodactyla/laurasiatheria_cetartiodactyla_mt12cp.aln ../taxa_to_add_cet.txt
# mt3cp
cd ../3 
perl ../phylip_to_fasta_and_extraseq.pl  ../../../../../../01_alignments/00_mammal_alns/laurasiatheria_therest/laurasiatheria_therest_mt3cp.aln \
../../../../../../01_alignments/00_mammal_alns/chiroptera/chiroptera_mt3cp.aln ../taxa_to_add_bats.txt \
../../../../../../01_alignments/00_mammal_alns/laurasiatheria_cetartiodactyla/laurasiatheria_cetartiodactyla_mt3cp.aln ../taxa_to_add_cet.txt
# mtrna
cd ../4
perl ../phylip_to_fasta_and_extraseq.pl  ../../../../../../01_alignments/00_mammal_alns/laurasiatheria_therest/laurasiatheria_therest_mtrna.aln \
../../../../../../01_alignments/00_mammal_alns/chiroptera/chiroptera_mtrna.aln ../taxa_to_add_bats.txt \
../../../../../../01_alignments/00_mammal_alns/laurasiatheria_cetartiodactyla/laurasiatheria_cetartiodactyla_mtrna.aln ../taxa_to_add_cet.txt
# nt12cp
cd ../5
perl ../phylip_to_fasta_and_extraseq.pl  ../../../../../../01_alignments/00_mammal_alns/laurasiatheria_therest/laurasiatheria_therest_nt12cp.aln \
../../../../../../01_alignments/00_mammal_alns/chiroptera/chiroptera_nt12cp.aln ../taxa_to_add_bats.txt \
../../../../../../01_alignments/00_mammal_alns/laurasiatheria_cetartiodactyla/laurasiatheria_cetartiodactyla_nt12cp.aln ../taxa_to_add_cet.txt
# nt3cp
cd ../6
perl ../phylip_to_fasta_and_extraseq.pl  ../../../../../../01_alignments/00_mammal_alns/laurasiatheria_therest/laurasiatheria_therest_nt3cp.aln \
../../../../../../01_alignments/00_mammal_alns/chiroptera/chiroptera_nt3cp.aln ../taxa_to_add_bats.txt \
../../../../../../01_alignments/00_mammal_alns/laurasiatheria_cetartiodactyla/laurasiatheria_cetartiodactyla_nt3cp.aln ../taxa_to_add_cet.txt

```

After checking that all the `species.txt` files are the same, which means that 
the sequences will be in the same order in all fasta files, then 
we can generate the concatenated file in dir `1`:

```sh
# Concatenated -- NOTE: "sequences.txt" files need to be in UNIX format,
# otherwise `paste` does not work!
# Run from `00_perl_parsing`
mkdir 1
cd 1
paste -d "" ../2/sequences.txt ../3/sequences.txt > laurasiatheria_therest.txt 
paste -d "" laurasiatheria_therest.txt ../4/sequences.txt > laurasiatheria_therest2.txt 
paste -d "" laurasiatheria_therest2.txt ../5/sequences.txt > laurasiatheria_therest3.txt 
paste -d "" laurasiatheria_therest3.txt ../6/sequences.txt > laurasiatheria_therest4.txt
rm laurasiatheria_therest.txt laurasiatheria_therest2.txt laurasiatheria_therest3.txt
mv laurasiatheria_therest4.txt laurasiatheria_therest.txt

# Now, add the species in fasta format
perl ../concatenated_format.pl laurasiatheria_therest.txt ../2/species.txt
```

# 2. Getting alignment with new tax
We copied the files in the directories `00_perl_parsing/[2-6]/forMAFFT` to directories 
labelled from 2 to 6 to run MAFFT in the Apocrita HPC.
Then, we downloaded the alignments generated by MAFFT from the cluster.
They were generated using the following command:

```sh
mafft --add $new_seq $aln_name >$out_name
```

To get the fasta sequences in one line, we ran the following code:

```sh
## Run from the directory `mafft_ltherest`
for i in `seq 2 6`
do

cd $i 
fasta=$( echo *outforMAFFT_out.fasta )
printf "Parsing "$fasta"...\n"
../../../../../../../../../src/one_line_fasta.pl $fasta
grep '>' $fasta | sed 's/>//' > species.txt
mkdir out_mafft 
mv $fasta out_mafft
fa=$( ls *fa )
name=$( echo $fa | sed 's/\_out..*//' )
mv $fa $name".fasta"
cd ../

done
```

Then, we used the file `species.txt` output for each of the alignments (one partition per alignment) to check 
that the order of the taxa was the same:

```sh
diff 2/species.txt 3/species.txt 
diff 2/species.txt 4/species.txt 
diff 2/species.txt 5/species.txt 
diff 2/species.txt 6/species.txt 
```

Once we made sure that the order was the same,
we had to generate the `sequences.txt` file alone without the `>species` header, otherwise the header 
would have been duplicated:

```
# Run from the directory `mafft_ltherest`
for i in `seq 2 6`
do 

cd $i 
perl ../../only_sequences.pl *fasta
cd ..

done
```

Now, we can concatenate the sequences in the same order that had been previously done 
(i.e., mt12cp > mt3cp > mtrna > nt12cp > nt3cp):

```
# Run from `mafft_ltherest`
mkdir 1
cd 1
paste -d "" ../2/*fasta ../3/laura*seq*txt > laurasiatheria_therest.fasta 
paste -d "" laurasiatheria_therest.fasta ../4/laura*seq*txt > laurasiatheria_therest2.fasta 
paste -d "" laurasiatheria_therest2.fasta ../5/laura*seq*txt > laurasiatheria_therest3.fasta 
paste -d "" laurasiatheria_therest3.fasta ../6/laura*seq*txt > laurasiatheria_therest4.fasta
rm laurasiatheria_therest.fasta laurasiatheria_therest2.fasta laurasiatheria_therest3.fasta
mv laurasiatheria_therest4.fasta laurasiatheria_therest.fasta
```

Now, the last step is to convert the FASTA files into PHYLIP format:

```
# Run from `mafft_ltherest`
for i in `seq 1 6`
do 

cd $i
num=$( grep '>' *fasta | wc -l )
len=$( sed -n '2,2p' *fasta | sed 's/\r//' | sed 's/\n//' | wc --m )
perl ../../FASTAtoPHYL.pl *fasta $num $len 
cd ..

done
```

Last, we generate the file with the five partitions concatenated:

```
# Run from `mafft_ltherest`
mkdir 7 
cd 7 

for i in `seq 2 6`
do 

cat ../$i/*aln >> laurasiatheria_therest_5parts.aln
printf "\n\n" >> laurasiatheria_therest_5parts.aln

done 
```

